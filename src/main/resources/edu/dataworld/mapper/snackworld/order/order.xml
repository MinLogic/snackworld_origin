<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="order">
    <select id="order.cartRetrieve" parameterType="edu.dataworld.snackworld.order.service.OrderVO" resultType="edu.dataworld.snackworld.order.service.OrderVO">
        SELECT
               D.IMG_URL
             , B.GDS_NAME
             , B.GDS_PRICE
             , (SELECT COMN_CD_NM
                FROM CODE_MNG C
                WHERE B.CAT_CODE = C.COMN_CD) CAT_CODE
             , A.QTY
             , A.CART_ID
             , A.GDS_ID
        FROM (SELECT GDS_ID
                   , QTY
                   , CART_ID
              FROM CART
              WHERE USER_ID = #{userId}
                AND DEL_YN = 'N') A
        JOIN GOODS B ON A.GDS_ID = B.GDS_ID
        LEFT JOIN GOODS_IMG_FILE D ON A.GDS_ID = D.GDS_ID;
    </select>

    <select id="order.orderRetrieve" parameterType="edu.dataworld.snackworld.order.service.OrderVO" resultType="edu.dataworld.snackworld.order.service.OrderVO">
        SELECT
            O.TOTAL_PRICE
            ,O.ORDER_STATUS_CODE
            ,O.USER_ID
            ,U.USER_NAME
        FROM `ORDER` O
        LEFT JOIN USER U
            ON U.USER_ID = O.USER_ID
    </select>

    <select id="order.listOption" parameterType="edu.dataworld.snackworld.order.service.OrderVO" resultType="edu.dataworld.snackworld.order.service.OrderVO">
        SELECT DISTINCT
            O.USER_ID,
            U.USER_NAME
        FROM `ORDER` O
        INNER JOIN USER U
            ON U.USER_ID = O.USER_ID;
    </select>

    <select id="order.orderCnt" parameterType="edu.dataworld.snackworld.order.service.OrderVO"  resultType="Integer">
        SELECT COUNT(*) AS ORDER_CNT
        FROM `ORDER`
        WHERE 1=1
        <if test='searchType != null and searchType != "" '>
            AND USER_ID = #{searchType}
        </if>
        <if test='searchType2 != null and searchType2 != "" '>
            AND STATUS = #{searchType2}
        </if>
    </select>

    <insert id="order.cartInsert" parameterType="edu.dataworld.snackworld.order.service.OrderVO" useGeneratedKeys="true">
        <selectKey resultType="String" keyProperty="cartId" order="BEFORE">
            SELECT
                   CONCAT('CART', (LPAD(IFNULL(CAST(RIGHT(MAX(CART_ID), 6) AS UNSIGNED) + 1, 1), 6, '0')))
            FROM   CART
        </selectKey>

        INSERT
        INTO CART(CART_ID
                , GDS_ID
                , USER_ID
                , QTY
                , DEL_YN
                , FRST_RGTR
                , FRST_REG_DT
                , LAST_CHNRG
                , LAST_CHG_DT)
        VALUES (
                #{cartId}
              , #{gdsId}
              , #{userId}
              , 1
              , 'N'
              , (SELECT
                        USER_NAME
                 FROM   USER
                 WHERE  USER_ID = #{userId})
              , NOW()
              , (SELECT
                        USER_NAME
                 FROM   USER
                 WHERE  USER_ID = #{userId})
              , NOW()
              )
    </insert>

    <update id="order.cartQtyUpdate" parameterType="edu.dataworld.snackworld.order.service.OrderVO">
        UPDATE CART
        SET    QTY = #{qty}
        WHERE  CART_ID = #{cartId}
    </update>

    <update id="order.cartDelete" parameterType="edu.dataworld.snackworld.order.service.OrderVO">
        UPDATE CART
        SET    DEL_YN = 'Y'
        WHERE  CART_ID = #{cartId}
    </update>

    <insert id="order.orderInsert" parameterType="edu.dataworld.snackworld.order.service.OrderVO" useGeneratedKeys="true">
        <selectKey resultType="String" keyProperty="orderID" order="BEFORE">
            SELECT
            CONCAT('ODR', (LPAD(IFNULL(CAST(RIGHT(MAX(CART_ID), 5) AS UNSIGNED) + 1, 1), 6, '0')))
            FROM   CART
        </selectKey>

        INSERT
        INTO ORDER(ORDER_ID
                 , USER_ID
                 , TOTAL_PRICE
                 , ORDER_STATUS_CODE
                 , DEL_YN
                 , FRST_RGTR
                 , FRST_REG_DT
                 , LAST_CHNRG
                 , LAST_CHG_DT)
        VALUES (#{orderID}
              , #{userId}
              , #{totalPrice}
              , 'A001'
              , 'N'
              , (SELECT
                        USER_NAME
                 FROM   USER
                 WHERE  USER_ID = #{userId})
              , NOW()
              , (SELECT
                        USER_NAME
                 FROM   USER
                 WHERE  USER_ID = #{userId})
              , NOW())
    </insert>

    <insert id="order.orderDetailInsert" parameterType="edu.dataworld.snackworld.order.service.OrderVO" useGeneratedKeys="true">
        <selectKey resultType="String" keyProperty="orderDetailID" order="BEFORE">
            SELECT
            CONCAT('ODRD', (LPAD(IFNULL(CAST(RIGHT(MAX(CART_ID), 6) AS UNSIGNED) + 1, 1), 6, '0')))
            FROM   CART
        </selectKey>

        INSERT
        INTO ORDER_DETAIL(ORDER_DETAIL_ID
                        , ORDER_ID
                        , GDS_ID
                        , QTY
                        , ORDER_STATUS_CODE
                        , DEL_YN
                        , FRST_RGTR
                        , FRST_REG_DT
                        , LAST_CHNRG
                        , LAST_CHG_DT)
        VALUES (#{orderDetailID}
              , #{orderID}
              , #{gdsId}
              , #{qty}
              , 'A001'
              , 'N'
              , (SELECT
                        USER_NAME
                 FROM   USER
                 WHERE  USER_ID = #{userId})
              , NOW()
              , (SELECT
                        USER_NAME
                 FROM   USER
                 WHERE  USER_ID = #{userId})
              , NOW())
    </insert>


</mapper>